import requests
from websocket import create_connection

# Twitch API credentials
client_id = 'jmvaq1k44xgiqnxccautb926g4gh3g'
client_secret = 'ugnuexo3io5xu8i8zmwfkwyumfcn0p'
username = 'tonybutlive'

# Step 1: Obtain an access token using client credentials flow
token_url = 'https://id.twitch.tv/oauth2/token'
params = {
    'client_id': client_id,
    'client_secret': client_secret,
    'grant_type': 'client_credentials',
    'scope': 'chat:read'  # Adjust scopes based on your needs
}
try:
    response = requests.post(token_url, params=params)
    response.raise_for_status()  # Raise an error for bad responses
    access_token = response.json()['access_token']

    # Twitch API endpoint for getting user ID
    user_id_url = f'https://api.twitch.tv/helix/users?login={username}'
    headers = {'Client-ID': client_id, 'Authorization': f'Bearer {access_token}'}
    response = requests.get(user_id_url, headers=headers)
    response.raise_for_status()
    user_id = response.json()['data'][0]['id']

    # Connect to Twitch chat
    ws_url = f'wss://irc-ws.chat.twitch.tv:443'
    ws = create_connection(ws_url)
    ws.send(f'PASS {access_token}')
    ws.send(f'NICK {username}')
    ws.send(f'JOIN #{username}')

    # Listen for chat messages
    try:
        while True:
            response = ws.recv()
            if 'PRIVMSG' in response:
                # Parse the message
                message_parts = response.split(':')
                sender = message_parts[1].split('!')[0]
                content = message_parts[2]

                # Check if the message contains "Burps so far:"
                if "Burps so far:" in content:
                    # Extract and print information (customize based on your needs)
                    print(f'Most recent message: {sender}: {content}')
    except KeyboardInterrupt:
        pass  # Allow script to exit gracefully on Ctrl+C
    finally:
        ws.close()

except requests.RequestException as e:
    print(f"Error in API request: {e}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")
